version: '3.8'

# 轻量级配置 - 使用预构建镜像，避免复杂构建过程
# 适用于网络环境受限的情况

services:
  # Nginx作为负载均衡器
  load-balancer:
    image: nginx:1.25-alpine  # 使用体积更小的Alpine版本
    container_name: proxy-load-balancer
    restart: unless-stopped
    ports:
      - "${PUBLIC_PORT:-8388}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - shadowsocks-proxy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

  # Shadowsocks代理服务 - 使用预构建镜像
  shadowsocks-proxy:
    image: teddysun/shadowsocks-libev:latest  # 预构建的shadowsocks-libev镜像
    container_name: proxy-shadowsocks
    restart: unless-stopped
    volumes:
      - ./logs/shadowsocks:/var/log/shadowsocks
    environment:
      - SERVER_PORT=8388
      - PASSWORD=${PASSWORD:?必须设置PASSWORD环境变量}
      - METHOD=${METHOD:-aes-256-gcm}
    ports:
      - "8388:8388/tcp"
      - "8388:8388/udp"
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z 0.0.0.0 8388"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

volumes:
  logs:
  nginx:

networks:
  default:
    driver: bridge