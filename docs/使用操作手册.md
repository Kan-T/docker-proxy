# Docker-Shadowsocks代理服务使用操作手册

## 概述

本文档提供了在CI/CD部署完成后，如何在不同平台上安装和配置客户端以使用部署在服务器上的Shadowsocks代理服务，实现对Google等国际网站的访问。

## 服务基本信息

根据部署配置，您的代理服务信息如下：

- **服务器地址**: babyaward.top
- **服务器端口**: 8388
- **密码**: 部署时设置的密码（默认为your_password，请确保已修改）
- **加密方式**: aes-256-gcm（默认值，可在部署时修改）
- **支持协议**: TCP + UDP

## 密码设置说明

### 修改默认密码的重要性

默认密码"your_password"存在严重安全风险，所有访问代理服务的客户端都需要使用正确的密码进行连接。为确保服务安全，强烈建议在部署时修改为强密码。

#### 1. 在部署前修改环境变量（推荐）

通过GitHub Actions Variables设置密码：

1. 访问GitHub仓库 → Settings → Secrets and variables → Actions
2. 在Variables选项卡中添加或修改以下变量：
   - 变量名: `PASSWORD`
   - 变量值: 设置为您的强密码（建议包含大小写字母、数字和特殊字符，长度不少于12位）
3. 保存设置后，推送代码到main分支将触发自动部署，新密码将自动应用

#### 2. 部署后通过阿里云ECS修改

如果已部署完成，可通过以下步骤修改密码：

```bash
# 登录ECS实例
ssh -i your-key.pem root@babyaward.top

# 进入部署目录
cd /data/docker-proxy/prod

# 修改.env文件中的PASSWORD字段
vim .env
# 将PASSWORD=your_password修改为您的新密码

# 重启服务使配置生效
docker-compose down
docker-compose up -d
```

## Windows平台配置指南

### 1. 安装Shadowsocks-Windows

1. 访问 [Shadowsocks-Windows GitHub](https://github.com/shadowsocks/shadowsocks-windows)
2. 下载最新版本的zip包（如Shadowsocks-X.X.X.zip）
3. 解压到任意目录，运行Shadowsocks-Windows.exe

### 2. 配置Shadowsocks客户端

1. 右键点击任务栏中的Shadowsocks图标，选择「服务器」→「编辑服务器」
2. 点击「添加」按钮，填写以下信息：
   - 服务器IP/地址: babyaward.top
   - 服务器端口: 8388
   - 密码: 您设置的密码（非默认的your_password）
   - 加密方式: aes-256-gcm
   - 备注: 可以自定义，如「Docker-Proxy」
3. 点击「确定」保存配置

### 3. 启动代理服务

1. 右键点击任务栏中的Shadowsocks图标
2. 选择「启动系统代理」
3. 确保「开机启动」选项已勾选（可选）

### 4. 配置浏览器代理（以Chrome为例）

1. 打开Chrome浏览器
2. 建议安装「SwitchyOmega」扩展
3. 配置SwitchyOmega：
   - 新建情景模式，名称为「SS代理」
   - 代理协议选择「SOCKS5」
   - 代理服务器: 127.0.0.1
   - 代理端口: 1080（默认值）
   - 点击「应用选项」保存
4. 在Chrome扩展栏点击SwitchyOmega图标，选择「SS代理」即可通过代理访问网站

## Mac平台配置指南

### 1. 安装ShadowsocksX-NG

#### 方法一：使用Homebrew安装（推荐）

打开终端，执行以下命令：

```bash
# 安装Homebrew（如果尚未安装）
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 安装ShadowsocksX-NG
brew install --cask shadowsocksx-ng
```

#### 方法二：直接下载安装包

1. 访问 [ShadowsocksX-NG GitHub](https://github.com/shadowsocks/ShadowsocksX-NG/releases)
2. 下载最新版本的.dmg安装包
3. 双击.dmg文件，将ShadowsocksX-NG拖入Applications文件夹
4. 打开应用程序，按照提示完成安装

### 2. 解决macOS应用验证警告

首次打开ShadowsocksX-NG时，macOS可能会显示"无法验证开发者"的警告。这是因为该应用未经过Apple的开发者认证。您可以通过以下方法解决：

#### 方法一：通过安全设置允许（推荐）
1. 当弹出警告窗口时，点击"取消"（不要点击"移到废纸篓"）
2. 打开"系统偏好设置" → "安全性与隐私" → "通用"选项卡
3. 您会看到一条信息："ShadowsocksX-NG.app是来自身份不明开发者的应用，已被阻止使用"
4. 点击右下角的"仍要打开"按钮
5. 在弹出的确认窗口中点击"打开"

#### 方法二：使用右键打开
1. 在Applications文件夹中找到ShadowsocksX-NG.app
2. 按住Control键并点击应用程序图标
3. 从弹出菜单中选择"打开"
4. 在确认窗口中点击"打开"

### 3. 关于系统密码请求弹窗

当您首次启动ShadowsocksX-NG或尝试启用系统代理时，macOS会显示一个要求输入用户密码的弹窗，提示"ShadowsocksX-NG想要进行更改"。这是正常现象，原因如下：

- ShadowsocksX-NG需要修改系统的网络代理设置才能正常工作
- 这是macOS的安全机制，确保只有授权用户才能修改系统级设置

**处理方法**：
1. 输入您的macOS用户密码（在弹窗中显示的用户名对应的密码）
2. 点击"好"按钮授权

授权后，ShadowsocksX-NG将能够自动配置和管理系统代理设置，您就可以正常使用代理服务了。

### 4. 配置Shadowsocks客户端

1. 点击菜单栏中的Shadowsocks图标（地球形状），选择「服务器设置」
2. 点击「+」按钮，选择「手动添加」
3. 填写以下信息：
   - 服务器地址: babyaward.top
   - 服务器端口: 8388
   - 密码: 您设置的密码（非默认的your_password）
   - 加密方式: aes-256-gcm
   - 备注: 可以自定义，如「Docker-Proxy」
4. 点击「确定」保存配置

### 5. 启动代理服务

1. 点击菜单栏中的Shadowsocks图标
2. 确保「开启Shadowsocks」选项已勾选
3. 可选：设置系统代理模式：
   - 全局模式: 所有流量都通过代理
   - 自动模式: 根据规则自动选择是否使用代理
   - 不代理: 不使用代理

### 6. 配置浏览器代理（以Chrome为例）

> **注意**：如果您在ShadowsocksX-NG中已经设置了"全局模式"或"自动模式"，浏览器可能已经自动通过代理访问，但使用SwitchyOmega可以让您更精确地控制哪些网站通过代理访问，哪些不通过。

1. 打开Chrome浏览器
2. 安装「SwitchyOmega」扩展（可在Chrome网上应用店搜索安装）
3. 安装完成后，点击Chrome右上角的SwitchyOmega图标，选择「选项」进入配置页面
4. 在左侧点击「新建情景模式」按钮
5. 输入情景模式名称（例如「SS代理」），选择「代理服务器」，然后点击「创建」
6. 在「代理协议」下拉菜单中选择「SOCKS5」
7. 在「代理服务器」文本框中输入：127.0.0.1
8. 在「代理端口」文本框中输入：1086（ShadowsocksX-NG默认值）
9. 确保勾选「为所有协议使用相同代理服务器」选项
10. 点击左上角的「应用选项」按钮保存配置

配置完成后，您需要：
11. 在Chrome扩展栏点击SwitchyOmega图标
12. 选择刚才创建的「SS代理」情景模式

这样，Chrome浏览器的流量就会通过Shadowsocks代理服务访问网站了。您可以随时切换不同的情景模式来控制是否使用代理。

## Android平台配置指南

### 1. 安装Shadowsocks Android客户端

1. 在Google Play商店搜索并安装"Shadowsocks"应用（开发者：Max Lv）
2. 或者从[Shadowsocks Android GitHub](https://github.com/shadowsocks/shadowsocks-android/releases)下载APK文件手动安装

### 2. 配置Shadowsocks客户端

1. 打开Shadowsocks应用
2. 点击右下角的"+"按钮
3. 选择"手动设置"
4. 填写以下信息：
   - 配置名称：可自定义（如"Docker-Proxy"）
   - 服务器：babyaward.top（或您的服务器IP地址）
   - 服务器端口：8388
   - 密码：您设置的密码（非默认的your_password）
   - 加密：aes-256-gcm
   - 路由：绕过局域网和中国大陆地址
   - UDP转发：开启
5. 点击右上角的"√"保存配置

### 3. 连接代理服务

1. 在配置列表中选择刚才创建的配置
2. 点击顶部的连接按钮（飞机图标）
3. 首次连接时，系统会请求VPN权限，点击"确定"或"允许"
4. 连接成功后，飞机图标会变为绿色

## iOS平台配置指南

### 1. 安装Shadowrocket客户端

在App Store搜索并安装"Shadowrocket"应用（需要使用非中国大陆Apple ID登录）

### 2. 配置Shadowrocket客户端

1. 打开Shadowrocket应用
2. 点击右上角的"+"按钮
3. 选择"手动添加"
4. 填写以下信息：
   - 类型：选择"Shadowsocks"
   - 服务器：babyaward.top（或您的服务器IP地址）
   - 端口：8388
   - 密码：您设置的密码（非默认的your_password）
   - 加密方式：aes-256-gcm
   - 备注：可自定义（如"Docker-Proxy"）
5. 点击右上角的"完成"保存配置

### 3. 连接代理服务

1. 在配置列表中选择刚才创建的配置
2. 点击应用主界面顶部的开关按钮开启代理
3. 系统会请求VPN权限，点击"允许"
4. 连接成功后，状态栏会显示VPN图标

## Linux平台配置指南

### 1. 安装Shadowsocks-libev客户端

#### Ubuntu/Debian系统

```bash
# 安装Shadowsocks-libev
apt update
apt install shadowsocks-libev
```

#### CentOS系统

```bash
# 安装EPEL源
yum install epel-release

# 安装Shadowsocks-libev
yum install shadowsocks-libev
```

### 2. 启动代理

```bash
# 启动本地代理
ss-local -s babyaward.top -p 8388 -l 1080 -k "您的密码" -m aes-256-gcm

# 后台运行（可选）
ss-local -s babyaward.top -p 8388 -l 1080 -k "您的密码" -m aes-256-gcm -d start
```

## 移动平台配置指南

### Android平台

1. 从Google Play或其他渠道下载并安装「Shadowsocks」应用
2. 打开应用，点击「+」按钮添加配置
3. 填写服务器信息：
   - 服务器: babyaward.top
   - 端口: 8388
   - 密码: 您设置的密码
   - 加密: aes-256-gcm
4. 保存配置，点击连接按钮

### iOS平台

1. 从App Store下载并安装「Shadowrocket」或「Potatso Lite」应用
2. 打开应用，添加服务器配置：
   - 类型: Shadowsocks
   - 服务器: babyaward.top
   - 端口: 8388
   - 密码: 您设置的密码
   - 加密: aes-256-gcm
3. 保存配置，启动代理

## 使用验证

配置完成后，可以通过以下方式验证代理是否正常工作：

1. 打开浏览器，访问Google网站：https://www.google.com
2. 如果能够成功访问，说明代理配置正确
3. 也可以通过检测IP地址的网站（如https://www.whatismyip.com/）查看您的公网IP是否发生变化

## 常见问题解决

### 1. 连接失败

- 检查服务器地址和端口是否正确
- 确认密码和加密方式是否与服务器配置一致
- 验证服务器是否正常运行：可以通过阿里云控制台检查ECS实例状态

### 2. 连接成功但无法访问网站

- 检查本地防火墙设置，确保没有阻止代理连接
- 尝试更换不同的加密方式
- 重启Shadowsocks客户端

### 3. 连接速度慢

- 检查服务器带宽使用情况
- 尝试切换不同的网络环境
- 考虑增加服务器资源或使用更高效的加密方式

## 代理故障排除详细流程

当您遇到通过代理无法访问网络的问题时，请按照以下步骤逐一排查：

### 步骤1：检查ShadowsocksX-NG客户端状态

1. 确认ShadowsocksX-NG图标显示为绿色（表示已连接）
2. 查看菜单中的状态显示是否为「Shadowsocks: On」
3. 如果显示连接失败，请重新输入密码并检查服务器设置

### 步骤2：验证本地代理服务

1. 打开Mac的「终端」应用
2. 首先检查ShadowsocksX-NG的本地端口设置：
   - 在ShadowsocksX-NG菜单中，选择「偏好设置」→「高级」
   - 查看「本地SOCKS5端口」和「本地HTTP端口」的设置值
3. 使用正确的本地端口运行以下命令测试本地代理服务：
   ```bash
   # 替换1086为您ShadowsocksX-NG中设置的实际SOCKS5本地端口（通常为1086）
   # 注意：不要使用服务器端口(8388)来连接本地代理
   curl -x socks5://127.0.0.1:1086 http://www.baidu.com
   ```
   > 注意：使用http而非https进行初始测试，以避免SSL错误干扰诊断
4. 如果返回百度的HTML内容，说明本地代理服务基本正常运行
5. 然后再尝试HTTPS连接：
   ```bash
   # 同样使用本地端口而非服务器端口
   curl -x socks5://127.0.0.1:1086 https://www.baidu.com
   ```

### 常见错误解决方案

#### 1. SSL连接错误 (`curl: (35) LibreSSL SSL_connect: SSL_ERROR_SYSCALL`)

如果遇到SSL连接错误：

1. **检查端口是否正确**：确保使用的是ShadowsocksX-NG中配置的正确本地端口
2. **验证ShadowsocksX-NG是否真正连接**：
   - 确认菜单中的状态为「Shadowsocks: On」
   - 观察状态栏图标是否为绿色且稳定
3. **检查服务器配置**：
   - 确认服务器地址(babyaward.top)正确无误
   - 验证服务器端口(8388)和加密方式(aes-256-gcm)设置正确
   - 确认密码输入正确
   - **注意：服务器端口(8388)与本地代理端口不同，本地端口通常为1086等，需在ShadowsocksX-NG偏好设置中查看**
4. **尝试HTTP连接**：如前所述，先测试HTTP连接确认基本代理功能
5. **检查防火墙设置**：确认macOS防火墙没有阻止代理连接
6. **重启ShadowsocksX-NG**：完全退出应用后重新打开
7. **检查本地网络环境**：某些公共网络可能阻止代理连接

#### 2. 空响应错误 (`curl: (52) Empty reply from server`)

如果遇到空响应错误：

1. **验证ShadowsocksX-NG客户端状态**：
   - 确认客户端显示「Shadowsocks: On」且图标为绿色
   - 尝试断开并重新连接ShadowsocksX-NG
2. **检查远程服务器连接**：
   - 确认服务器地址(babyaward.top)可访问
   - 验证服务器端口(8388)未被ISP或防火墙屏蔽
3. **检查服务器配置**：
   - 重新输入密码确保正确
   - 确认加密方式(aes-256-gcm)设置正确
4. **尝试不同的网络环境**：
   - 如有可能，连接不同的WiFi网络测试
   - 检查是否存在网络限制或防火墙阻止
5. **重启ShadowsocksX-NG客户端**：
   - 完全退出应用，重新启动
   - 必要时重启计算机
6. **检查服务器状态**：
   - 联系服务器管理员确认服务器正常运行
   - 查看服务器日志以获取更多信息

### 步骤3：检查浏览器代理设置

1. 对于Chrome浏览器，确认SwitchyOmega扩展已正确配置：
   - 代理服务器地址：127.0.0.1
   - 端口：1086（ShadowsocksX-NG默认SOCKS5端口）
   - 已勾选「为所有协议使用相同代理服务器」
2. 尝试切换到「全局模式」，然后在浏览器中直接访问网站
3. 如果使用PAC自动模式，尝试更新PAC文件

### 步骤4：检查系统网络设置

1. 打开Mac的「系统偏好设置」→「网络」
2. 选择当前使用的网络连接，点击「高级」→「代理」
3. 确保没有其他代理设置与Shadowsocks冲突
4. 尝试关闭所有系统代理设置，仅使用Shadowsocks客户端的代理

### 步骤5：测试基本连接

1. 暂时关闭Shadowsocks，确认不使用代理时可以正常访问国内网站
2. 使用不同的浏览器测试，看是否是特定浏览器的问题
3. 尝试访问不同类型的网站，判断是否是特定网站的问题

### 步骤6：检查系统防火墙

1. 打开Mac的「系统偏好设置」→「安全性与隐私」→「防火墙」
2. 点击「防火墙选项」，检查是否阻止了Shadowsocks或浏览器的网络访问
3. 临时关闭防火墙进行测试，看是否解决问题

### 步骤7：重置Shadowsocks配置

1. 在ShadowsocksX-NG中删除当前配置
2. 重新添加服务器配置，确保所有参数正确
3. 重启ShadowsocksX-NG客户端

### 步骤8：查看服务器状态

如果以上步骤都无法解决问题，可能是服务器端的问题：

1. 通过阿里云控制台检查ECS实例状态
2. 检查服务器防火墙和安全组设置，确保端口8388已开放
3. 联系服务器管理员检查代理服务是否正常运行

## 安全建议

1. **定期更换密码**: 建议每3个月更换一次密码
2. **使用强密码**: 确保密码包含大小写字母、数字和特殊字符
3. **限制访问来源**: 可以通过阿里云安全组设置，仅允许特定IP访问代理端口
4. **定期更新客户端**: 确保使用最新版本的Shadowsocks客户端以获取安全更新
5. **避免在公共WiFi使用代理**: 在不确定安全的网络环境下，建议谨慎使用代理服务

## 维护与更新

- 服务端更新将通过GitHub Actions自动部署
- 客户端应定期检查并更新到最新版本
- 如遇到无法解决的问题，请检查服务器日志获取更多信息：
  ```bash
  # 登录服务器查看日志
  ssh -i your-key.pem root@babyaward.top
  docker logs proxy-load-balancer
  docker logs shadowsocks-proxy
  ```

## 部署问题排查

### Docker构建超时问题

如果遇到CI/CD显示部署成功但服务器上没有运行的容器：

1. **检查构建日志错误**：
   - 关注日志中的 `ERROR: failed to build: DeadlineExceeded: context deadline exceeded` 错误
   - 这表明Docker镜像构建过程超时

2. **手动部署解决方案**：
   - 登录ECS服务器：`ssh deploy@your-ecs-ip`
   - 进入部署目录：`cd /data/docker-proxy/prod`
   - 手动构建镜像：`docker-compose build --no-cache`
   - 启动容器：`docker-compose up -d`

3. **增加构建超时设置**：
   - 在Docker daemon配置中增加超时设置
   - 编辑 `/etc/docker/daemon.json` 文件
   - 添加 `{"buildkit": true, "max-concurrent-downloads": 3, "max-concurrent-uploads": 3}`
   - 重启Docker服务：`systemctl restart docker`

4. **检查系统资源**：
   - 确保ECS实例有足够的CPU和内存资源
   - 使用 `top` 或 `htop` 命令检查系统负载

5. **验证网络连接**：
   - 确认Docker拉取镜像的网络连接正常
   - 可以配置Docker国内镜像源加速构建

6. **查看完整部署日志**：
   - 登录GitHub Actions查看完整的部署日志
   - 服务器上查看部署脚本输出：`cat /tmp/deploy_simple.log`（如果脚本被修改为保存日志）