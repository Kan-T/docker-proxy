version: '3.8'

# 全局配置 - 注意：如需加速镜像拉取，可在系统Docker配置中添加镜像源
# 示例：在/etc/docker/daemon.json中添加国内镜像加速源
# {
#   "registry-mirrors": ["https://registry.docker-cn.com", "https://docker.mirrors.ustc.edu.cn"]
# }

# 建议：如遇网络问题，可尝试使用本地已有镜像或通过其他方式提前拉取
services:
  # Nginx作为负载均衡器，支持水平扩展
  load-balancer:
    image: nginx:1.25
    container_name: proxy-load-balancer
    restart: unless-stopped
    ports:
      - "${PUBLIC_PORT:-8388}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./logs/nginx:/var/log/nginx
    # 只依赖shadowsocks-proxy服务，不依赖监控服务
    depends_on:
      - shadowsocks-proxy
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

  # Shadowsocks代理服务（支持多实例扩展）
  shadowsocks-proxy:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - IMAGE_VERSION=${IMAGE_VERSION:-latest}
    # 移除固定容器名以支持多实例
    restart: unless-stopped
    volumes:
      - ./logs/shadowsocks:/var/log/shadowsocks
      # 配置目录改为只读以提高安全性
      - ./config:/etc/shadowsocks:ro
    environment:
      - SERVER_PORT=8388
      - PASSWORD=${PASSWORD:-your_password}
      - METHOD=${METHOD:-aes-256-gcm}
      - TIMEOUT=${TIMEOUT:-300}
      - DNS_SERVER=${DNS_SERVER:-8.8.8.8}
      - UDPSUPPORT=${UDPSUPPORT:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - INSTANCE_ID={{.Task.Slot}}
    # 改进健康检查，减少外部依赖
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z 0.0.0.0 8388 && ss-server -c /etc/shadowsocks/shadowsocks.json -t 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      # 支持水平扩展
      replicas: ${REPLICAS:-1}
      # 添加标签支持版本管理
      labels:
        - "com.docker.proxy.version=${IMAGE_VERSION:-latest}"
        - "com.docker.proxy.env=${ENVIRONMENT:-development}"
      # 添加更新策略支持回滚
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 30s
        max_failure_ratio: 0.3
      # 添加重启策略
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 60s
      # 资源限制
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # 监控服务（Prometheus + Grafana）- 可选服务
  # cadvisor:
  #   # 使用Docker Hub替代镜像
  #   image: zcube/cadvisor:v0.47.0
  #   container_name: proxy-cadvisor
  #   restart: unless-stopped
  #   volumes:
  #     - /:/rootfs:ro
  #     - /var/run:/var/run:ro
  #     - /sys:/sys:ro
  #     - /var/lib/docker/:/var/lib/docker:ro
  #   ports:
  #     - "8080:8080"
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '0.3'
  #         memory: 256M

volumes:
  logs:
  nginx:
  config:

# 添加网络配置，支持服务发现
networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16